# -*- coding: utf-8 -*-
import os
import json
import re
from dotenv import load_dotenv
from openai import OpenAI

# -----------------------------------------
# Загружаем ключи из .env
# -----------------------------------------
load_dotenv()

folder_id = os.getenv("folder_id")
api_key   = os.getenv("api_key")

MODEL = f"gpt://{folder_id}/qwen3-235b-a22b-fp8/latest"

client = OpenAI(
    base_url="https://rest-assistant.api.cloud.yandex.net/v1",
    api_key=api_key,
    project=folder_id
)


# -----------------------------------------
# ВХОДНЫЕ ДАННЫЕ
# -----------------------------------------
# draft_answers_json = JSON из llm2_output.json
# LLM2 result
with open("llm2_output.json", "r", encoding="utf-8") as f:
    draft_answers_json = json.load(f)


# -----------------------------------------
# PROMPT TEMPLATE (как ты дал)
# -----------------------------------------
LLM3_PROMPT_TEMPLATE = """Ты — юридический и комплаенс-эксперт крупного банка.

ТВОЯ РОЛЬ:
- Ты проверяешь и при необходимости исправляешь проекты ответов клиентам, партнёрам и регуляторам.
- Ты пишешь на русском языке, в корректном деловом стиле.
- Ты обязан соблюдать юридическую осторожность и избегать избыточных обещаний.
- У тебя НЕТ доступа к исходному письму и дополнительным данным, кроме переданных черновых ответов.

ЧТО НЕЛЬЗЯ:
- НЕЛЬЗЯ придумывать суммы, даты, реквизиты договоров, имена людей, названия подразделений и любые факты, которых нет в черновых ответах.
- НЕЛЬЗЯ добавлять категоричные обещания результата.
- НЕЛЬЗЯ добавлять технические комментарии.

ЧТО МОЖНО И НУЖНО:
- Смягчать формулировки, которые звучат как жёсткие обещания результата.
- Использовать выражения: «Банк рассмотрит…», «Банк проведёт проверку…», «Решение будет принято…».
- Удалять конфликтные, резкие или эмоциональные элементы.
- Делать ответы аккуратными, юридически безопасными.
- Сохранять общий смысл и структуру.

ФОРМАТ ВЫВОДА:
Верни ОДИН валидный JSON:

{{
  "answers": {{
    "official": "скорректированный официальный ответ",
    "business": "скорректированный деловой ответ",
    "client_friendly": "скорректированный клиентоориентированный ответ",
    "simple": "скорректированный упрощённый ответ"
  }},
  "issues": {{
    "official": ["замечание 1", "замечание 2"],
    "business": ["замечание 1"],
    "client_friendly": ["..."],
    "simple": ["..."]
  }}
}}

--------------------------------
ВХОДНЫЕ ДАННЫЕ
--------------------------------

Ниже приведён JSON с черновыми ответами от предыдущей модели (LLM2):

{draft_json}

Ожидаемая структура входных данных:

{{
  "answers": {{
    "official": "...",
    "business": "...",
    "client_friendly": "...",
    "simple": "..."
  }}
}}

--------------------------------
ТВОЯ ЗАДАЧА
--------------------------------

1. Для каждого варианта ответа:
   - Найди потенциальные риски, обещания или некорректные формулировки.
   - При необходимости переформулируй, сохранив смысл.
2. Заполни две секции: "answers" и "issues".
3. ВЕРНИ строго такой JSON:

{{
  "answers": {{
    "official": "...",
    "business": "...",
    "client_friendly": "...",
    "simple": "..."
  }},
  "issues": {{
    "official": ["..."],
    "business": ["..."],
    "client_friendly": ["..."],
    "simple": ["..."]
  }}
}}
"""


# -----------------------------------------
# Подставляем входные данные в PROMPT
# -----------------------------------------
prompt = LLM3_PROMPT_TEMPLATE.format(
    draft_json=json.dumps(draft_answers_json, ensure_ascii=False, indent=2)
)


# -----------------------------------------
# Вызов модели Yandex LLM
# -----------------------------------------
response = client.responses.create(
    model=MODEL,
    input=prompt,
    max_output_tokens=1500,
    temperature=0.1
)

raw = response.output_text.strip()


# -----------------------------------------
# Извлекаем JSON из ответа
# -----------------------------------------
if raw.startswith("```"):
    raw = raw.strip("`")
    if raw.startswith("json"):
        raw = raw[4:].strip()

start = raw.find("{")
end   = raw.rfind("}")

if start != -1 and end != -1:
    json_str = raw[start:end+1]
else:
    json_str = raw

try:
    result = json.loads(json_str)
except:
    result = {
        "answers": {
            "official": "",
            "business": "",
            "client_friendly": "",
            "simple": ""
        },
        "issues": {
            "official": [],
            "business": [],
            "client_friendly": [],
            "simple": []
        }
    }


# -----------------------------------------
# Сохраняем результат в файл
# -----------------------------------------
with open("llm3_output.json", "w", encoding="utf-8") as f:
    json.dump(result, f, ensure_ascii=False, indent=2)

print("Файл сохранён → llm3_output.json")